/*
 * ===========================================
 * CP1.4 - Reto 1 (CI) - Jenkinsfile (develop)
 * + Reto 4 (Config repo samconfig.toml)
 * ===========================================
 */

def shLogged(String label, String script) {
    sh(label: label, script: """#!/usr/bin/env bash
set -euo pipefail
${script}
""")
}

def ensureReportsDirs() {
    shLogged('Ensure reports dirs', '''
        mkdir -p reports/static
        mkdir -p reports/deploy
        mkdir -p reports/rest
    ''')
}

def logAgentInfo(String stageName) {
    shLogged("Agent info (${stageName})", '''
        echo "=== Agent info ==="
        whoami || true
        hostname || true
        echo "WORKSPACE=$WORKSPACE"
    ''')
}

def requireFile(String path) {
    shLogged("Require file: ${path}", """
        test -f '${path}'
        echo "OK: found ${path}"
    """)
}

pipeline {
    agent any

    options {
        timestamps()
        skipDefaultCheckout(true)
    }

    environment {
        PYTHON_BIN = '/opt/jenkins-tools/venv/bin/python'

        // AWS
        AWS_REGION = 'us-east-1'

        // Repo app
        REPO_URL = 'https://github.com/alloci88/todo-list-aws.git'
        CI_BRANCH = 'develop'
        MASTER_BRANCH = 'master'

        // Repo config (Reto 4)
        CONFIG_REPO_OWNER = 'alloci88'
        CONFIG_REPO_NAME = 'todo-list-aws-config'
        CONFIG_BRANCH = 'staging'
        SAMCONFIG_FILE = 'samconfig.toml'

        // Static reports
        FLAKE8_OUT = 'reports/static/flake8.out'
        BANDIT_OUT = 'reports/static/bandit.out'
        BANDIT_JSON = 'reports/static/bandit.json'

        // Deploy
        STACK_NAME_STAGING = 'staging-todo-list-aws'
        API_URL_FILE = 'reports/deploy/api_url.txt'

        // Rest tests
        REST_JUNIT = 'reports/rest/junit-integration.xml'
        INTEGRATION_TEST_FILE = 'test/integration/todoApiTest.py'

        // Git identity
        GIT_USER_NAME = 'jenkins-ci'
        GIT_USER_EMAIL = 'jenkins-ci@example.local'
    }

    stages {

        stage('Get Code') {
            steps {
                logAgentInfo('Get Code')
                deleteDir()

                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.CI_BRANCH}"]],
                    userRemoteConfigs: [[url: "${env.REPO_URL}"]],
                    extensions: [[$class: 'CloneOption', shallow: false, depth: 0, noTags: false]]
                ])

                ensureReportsDirs()

                withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'GH_TOKEN')]) {
                    shLogged('Download samconfig.toml (staging)', '''
                        RAW_URL="https://raw.githubusercontent.com/${CONFIG_REPO_OWNER}/${CONFIG_REPO_NAME}/${CONFIG_BRANCH}/${SAMCONFIG_FILE}"

                        curl -fsSL \
                          -H "Authorization: token $GH_TOKEN" \
                          -H "Accept: application/vnd.github.v3.raw" \
                          "$RAW_URL" \
                          -o "$SAMCONFIG_FILE"

                        echo "Downloaded $SAMCONFIG_FILE from $RAW_URL"
                    ''')
                }

                requireFile(env.SAMCONFIG_FILE)

                stash name: 'SRC',
                      includes: '**/*',
                      excludes: '.git/**,reports/**,**/__pycache__/**',
                      useDefaultExcludes: false
            }
        }

        stage('Static Test') {
            steps {
                logAgentInfo('Static Test')
                deleteDir()
                unstash 'SRC'
                ensureReportsDirs()

                shLogged('Run Flake8 (src only)', '''
                    "$PYTHON_BIN" -m flake8 src \
                      --exit-zero \
                      --format=pylint \
                      > "$FLAKE8_OUT"
                ''')

                shLogged('Run Bandit (src only)', '''
                    "$PYTHON_BIN" -m bandit -r src \
                      --exit-zero \
                      -f custom -o "$BANDIT_OUT" \
                      --msg-template "{abspath}:{line}: [{test_id}] {msg}"

                    "$PYTHON_BIN" -m bandit -r src \
                      --exit-zero \
                      -f json -o "$BANDIT_JSON"
                ''')

                requireFile(env.FLAKE8_OUT)
                requireFile(env.BANDIT_OUT)
                requireFile(env.BANDIT_JSON)
            }
            post {
                always {
                    recordIssues(
                        enabledForFailure: true,
                        tools: [
                            pyLint(id: 'flake8', name: 'Flake8', pattern: "${FLAKE8_OUT}"),
                            pyLint(id: 'bandit', name: 'Bandit', pattern: "${BANDIT_OUT}")
                        ]
                    )

                    archiveArtifacts artifacts: 'reports/static/*', fingerprint: true, allowEmptyArchive: false
                }
            }
        }

        stage('Deploy') {
            steps {
                logAgentInfo('Deploy')
                deleteDir()
                unstash 'SRC'
                ensureReportsDirs()

                requireFile(env.SAMCONFIG_FILE)

                shLogged('SAM build', '''
                    sam build
                ''')

                shLogged('SAM validate', '''
                    sam validate --region "$AWS_REGION"
                ''')

                shLogged('SAM deploy (staging, non-interactive, config repo)', '''
                    sam deploy \
                      --config-file "$SAMCONFIG_FILE" \
                      --config-env staging \
                      --region "$AWS_REGION" \
                      --no-confirm-changeset \
                      --no-fail-on-empty-changeset
                ''')

                shLogged('Resolve API URL from CloudFormation outputs (BaseUrlApi)', '''
                    API_URL=$(aws --region "$AWS_REGION" cloudformation describe-stacks \
                        --stack-name "$STACK_NAME_STAGING" \
                        --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue | [0]" \
                        --output text)

                    if [[ -z "$API_URL" || "$API_URL" == "None" ]]; then
                        echo "ERROR: BaseUrlApi not found in stack outputs"
                        aws --region "$AWS_REGION" cloudformation describe-stacks --stack-name "$STACK_NAME_STAGING" --query "Stacks[0].Outputs" --output table || true
                        exit 1
                    fi

                    echo "$API_URL" | tee "$API_URL_FILE"
                ''')

                requireFile(env.API_URL_FILE)

                archiveArtifacts artifacts: 'reports/deploy/*', fingerprint: true, allowEmptyArchive: false

                stash name: 'DEPLOY_META',
                      includes: 'reports/deploy/*',
                      useDefaultExcludes: false
            }
        }

        stage('Rest Test') {
            steps {
                logAgentInfo('Rest Test')
                deleteDir()
                unstash 'SRC'
                unstash 'DEPLOY_META'
                ensureReportsDirs()

                shLogged('Run Pytest integration (abort on fail)', '''
                    export BASE_URL="$(cat "$API_URL_FILE")"
                    echo "BASE_URL=$BASE_URL"

                    test -f "$INTEGRATION_TEST_FILE"

                    "$PYTHON_BIN" -m pytest -q \
                      --junitxml="$REST_JUNIT" \
                      "$INTEGRATION_TEST_FILE"
                ''')
            }
            post {
                always {
                    junit testResults: 'reports/rest/*.xml', allowEmptyResults: false
                    archiveArtifacts artifacts: 'reports/rest/*,reports/deploy/*', fingerprint: true, allowEmptyArchive: true
                }
            }
        }

        stage('Promote') {
            steps {
                logAgentInfo('Promote')
                deleteDir()

                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${env.CI_BRANCH}"]],
                    userRemoteConfigs: [[url: "${env.REPO_URL}"]],
                    extensions: [[$class: 'CloneOption', shallow: false, depth: 0, noTags: false]]
                ])

                withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'GH_TOKEN')]) {
                    shLogged('Git promote develop -> master (protect Jenkinsfiles on master)', '''
                        git config user.name "$GIT_USER_NAME"
                        git config user.email "$GIT_USER_EMAIL"

                        git remote set-url origin "https://$GH_TOKEN@github.com/alloci88/todo-list-aws.git"
                        git fetch origin

                        git checkout -B "$CI_BRANCH" "origin/$CI_BRANCH"

                        echo "Promoted by Jenkins build $BUILD_NUMBER at $(date -Iseconds)" >> CHANGELOG.md
                        git add CHANGELOG.md
                        git commit -m "chore(release): promote build $BUILD_NUMBER" || true
                        git push origin "$CI_BRANCH"

                        git checkout "$MASTER_BRANCH"
                        git pull origin "$MASTER_BRANCH"
                        git merge --no-ff "origin/$CI_BRANCH" -m "merge: $CI_BRANCH -> $MASTER_BRANCH (build $BUILD_NUMBER)"

                        # PROTECCIÓN REAL (nombres en mayúsculas)
                        git checkout --ours JENKINSFILE 2>/dev/null || true
                        git checkout --ours JENKINSFILE_agentes 2>/dev/null || true
                        git add JENKINSFILE JENKINSFILE_agentes 2>/dev/null || true
                        git commit --amend --no-edit || true

                        git push origin "$MASTER_BRANCH"
                    ''')
                }
            }
        }
    }
}